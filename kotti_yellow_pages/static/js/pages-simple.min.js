var PagesCtrl,__indexOf=[].indexOf||function(c){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===c){return b}}return -1};PagesCtrl=function(j,h,b,k,f,a){var i,g,e,c,d;j.safeApply=function(m){var l;l=this.$root.$$phase;if(l==="$apply"||l==="$digest"){if(m&&(typeof m==="function")){return m()}}else{return this.$apply(m)}};c=function(){var t,v,s,r,w,p,o,u,l,q,n,m;q=j.companies;m=[];for(p=0,u=q.length;p<u;p++){s=q[p];w=(function(){var A,y,x,z;x=s.branches;z=[];for(A=0,y=x.length;A<y;A++){t=x[A];if(t.selected===true){z.push(t.title)}}return z})();s.branches=(function(){var A,y,x,B,z;x=j.branches;z=[];for(A=0,y=x.length;A<y;A++){t=x[A];if(B=t.title,__indexOf.call(w,B)>=0){z.push(t)}}return z})();n=s.branches;for(o=0,l=n.length;o<l;o++){v=n[o];v.companies.push(s)}s.showDetails=function(y,A){var C,z,x,B;if(A==null){A=true}if(y===true||y===false){this._showDetails=y;if(this.marker){if(y){this.marker.setIcon(this.marker.selectedIcon)}else{this.marker.setIcon(this.marker.defaultIcon)}}}if(A){if(y){j.hideCompaniesTable=true;B=j.companies;for(z=0,x=B.length;z<x;z++){C=B[z];if(C!==this){C.showDetails(false,false)}}}if(y===false){j.hideCompaniesTable=false}}return this._showDetails};s.onClick=function(x){k.info("click");return j.safeApply(function(){x.target.setIcon(x.target.selectedIcon);return x.target.company.showDetails(true)})};if(!s.marker&&s.location.lat&&s.location.lng){s.latlng=new L.LatLng(s.location.lat,s.location.lng);r=new L.marker(s.latlng,{title:s.title,riseOnHover:true,riseOffset:1000});r.company=s;r.defaultIcon=a.makeIcon({color:"darkgreen",icon:"question-sign"});r.hoverIcon=a.makeIcon({color:"green",icon:"info-sign"});r.selectedIcon=a.makeIcon({color:"green",icon:"star"});r.setIcon(r.defaultIcon);r.on("click",s.onClick);r.on("mouseover",function(x){var y;r=x.target;if((y=r.options.icon)!==r.selectedIcon&&y!==r.hoverIcon){return r.setIcon(r.hoverIcon)}});r.on("mouseout",function(x){var y;r=x.target;if((y=r.options.icon)!==r.selectedIcon&&y!==r.defaultIcon){return r.setIcon(r.defaultIcon)}});s.marker=r}s.visible=function(){var y,x;y=__indexOf.call((function(){var B,z,C,A;C=this.branches;A=[];for(B=0,z=C.length;B<z;B++){t=C[B];A.push(t.visible)}return A}).call(this),true)>=0;x=this.latlng&&j.map.getBounds().contains(this.latlng);return y&&x};m.push(s.distanceToUser=function(){if(!(this.latlng&&j.user.latlng)){return this.distance=null}return this.distance=Math.round(this.latlng.distanceTo(j.user.latlng)/1000,10)})}return m};j.distanceToZipcode=function(l){if(l.distanceToUser){return l.distanceToUser()}else{return false}};j.companyName=function(l){return l.title};j.companyZipcode=function(l){return l.zipcode};j.companyListOrder=function(l){if(!j.listOrderBy){j.listOrderBy="companyZipcode"}return j[j.listOrderBy](l)};j.numCompaniesVisible=function(){var l;return((function(){var o,n,m;m=[];for(o=0,n=companies.length;o<n;o++){l=companies[o];if(l.visible()){m.push(l)}}return m})()).length};e=function(){var n,q,p,m,o,l;k.info("initBranches");o=j.branches;l=[];for(p=0,m=o.length;p<m;p++){n=o[p];n.visible=false;l.push(n.bounds=new L.LatLngBounds((function(){var u,s,r,t;r=n.companies;t=[];for(u=0,s=r.length;u<s;u++){q=r[u];if(q.latlng){t.push(q.latlng)}}return t})()))}return l};d=function(){var l;k.info("initMap");b.map=j.map=a;a.on("load move moveend drag dragend zoomend",function(m){return j.safeApply(function(){j.map.getBounds();return j.mapCenter=j.map.getCenter()})});a.bounds=new L.LatLngBounds((function(){var p,n,o,m;o=j.branches;m=[];for(p=0,n=o.length;p<n;p++){l=o[p];m.push(l.bounds)}return m})());return a.fitBounds(a.bounds)};j.updateBranchesVisible=function(){var o,n,q,m,p,l;k.info("updateBranchesVisible");p=j.branches;l=[];for(q=0,m=p.length;q<m;q++){o=p[q];if(o.title===j.selected_branch){o.visible=true}else{o.visible=false}l.push((function(){var u,s,r,t;r=o.companies;t=[];for(u=0,s=r.length;u<s;u++){n=r[u];if(n.marker){if(o.visible&&!a.hasLayer(n.marker)){a.addLayer(n.marker)}if(!o.visible&&a.hasLayer(n.marker)){t.push(a.removeLayer(n.marker))}else{t.push(void 0)}}else{t.push(void 0)}}return t})())}return l};j.$watch("selected_branch",function(m){var l;l=j.user;if(l&&l.zipcode&&l.zipcode.length===5){j.updateBranchesVisible();return j.maybeShowMap()}});i=f.defer();j.$watch("branches",function(l){k.info("Got "+l.length+" branches.");b.branches=l;return i.resolve()});g=f.defer();j.$watch("companies",function(l){k.info("Got "+l.length+" companies.");b.companies=l;return g.resolve()});j.panAndZoom=function(){if(!(j.user&&j.user.latlng)){return}return j.safeApply(function(){var l;a.panTo(j.user.latlng);l=function(m){if(j.numCompaniesVisible()<=1){return a.zoomOut()}else{return a.off("zoomend",l)}};a.on("zoomend",l);return a.setZoom(13)})};j.maybeShowMap=function(){var l;l=j.user;if(l&&l.zipcode&&l.zipcode.length===5&&j.selected_branch){$(".companies_listing").slideDown();$(".company-search").slideUp();j.updateBranchesVisible();j.panAndZoom();return true}else{$(".companies_listing").slideUp();$(".company-search").slideDown();return false}};j.newSearch=function(){j.selected_branch="";j.user.zipcode=null;j.updateBranchesVisible();return j.maybeShowMap()};j.latLngForUser=function(){if(!j.user||j.user.zipcode.length!==5){$(".companies_listing").slideUp();$(".company-search").slideDown();return false}return a.latLngForAddress(j.user).then(function(n){var o,m,l;if(n.length>0){l=n[0].locations;if(l.length>0){m=l[0];o=m.latLng;j.user.latlng=new L.LatLng(o.lat,o.lng)}else{j.user.latlng=null;j.user.zipcode="";alert("Unbekannte PLZ")}return j.maybeShowMap()}})};j.$watch("user",j.latLngForUser,true);return f.all([i.promise,g.promise]).then(function(){k.info("Initializing...");c();e();d();j.listOrderBy="distanceToZipcode";b.user=j.user={zipcode:"",country:"DE"};j.latLngForUser();return j.updateBranchesVisible()})};