// Generated by CoffeeScript 1.6.2
/**
 * CompanyEdit view controller
 * @param {ng.Scope} $scope Controller scope
 * @param {ng.$http} $http  AngularJS HTTP service
 * @param {L.map}    map    Map object with tileLayer and additional
 *                          latLngForAddress method.
*/

var CompanyEditCtrl;

CompanyEditCtrl = function($scope, $http, $log, map) {
  var handleLocationChange;

  $scope.location = new L.LatLng(0, 0);
  $scope.map = map;
  $scope.map.setView($scope.location, 6);
  $scope.marker = L.marker($scope.location, {
    draggable: true
  }).addTo($scope.map);
  /**
   * Pass the address from the scope to the latLngForAddress service method and
   * update location if a geolocation is returned by the API endpoint.
  */

  $scope.locateAddress = function() {
    $log.info("Updating location from scope.address...");
    if (!$scope.addressSubform.$valid) {
      return false;
    }
    map.latLngForAddress($scope.company.address).then(function(results) {
      var latlng, locations;

      if (results.length !== 1) {
        $log.warn("response.data contains " + results.length + " results.");
        return false;
      }
      locations = results[0].locations;
      if (locations.length < 1) {
        $log.warn("results[0] contains " + locations.length + " locations.");
        return false;
      }
      latlng = locations[0].latLng;
      latlng = new L.LatLng(latlng.lat, latlng.lng);
      $scope.company.location.lat = latlng.lat;
      $scope.company.location.lng = latlng.lng;
      return $scope.setMarkerFromLocation();
    });
    return false;
  };
  /**
   * Update the marker position with the location from the scope.  Also update
   * the corresponding input fields' values.
  */

  $scope.setMarkerFromLocation = function() {
    $log.info("Updating marker position and form field values from scope.location...");
    $scope.marker.setLatLng($scope.company.location);
    $scope.map.panTo($scope.company.location);
    $scope.map.setZoom(14);
    return false;
  };
  $scope.marker.on("dragend", function(e) {
    return $scope.$apply(function() {
      $scope.company.location.lat = e.target._latlng.lat;
      return $scope.company.location.lng = e.target._latlng.lng;
    });
  });
  handleLocationChange = function() {
    var l;

    $log.info("handleLocationChange");
    l = $scope.company.location;
    if (!(l && l.lat && l.lng)) {
      return false;
    }
    if (!L.LatLng.isPrototypeOf($scope.company.location)) {
      $scope.company.location = new L.LatLng(l.lat, l.lng);
    }
    return $scope.setMarkerFromLocation();
  };
  $scope.$watch('company.location.lat', handleLocationChange, false);
  return $scope.$watch('company.location.lng', handleLocationChange, false);
};
