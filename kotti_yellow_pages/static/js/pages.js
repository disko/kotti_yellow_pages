// Generated by CoffeeScript 1.6.2
var PagesCtrl,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

PagesCtrl = function($scope, $http, $window, $log, $q, map) {
  /**
   * Initialize the company objects.
  */

  var branchesInitialized, companiesInitialized, initBranches, initCompanies, initMap;

  initCompanies = function() {
    var b, branch, company, _branch_names, _i, _j, _len, _len1, _ref, _ref1, _results;

    $log.info("initCompanies");
    _ref = $scope.companies;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      company = _ref[_i];
      _branch_names = (function() {
        var _j, _len1, _ref1, _results1;

        _ref1 = company.branches;
        _results1 = [];
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          b = _ref1[_j];
          if (b.selected === true) {
            _results1.push(b.title);
          }
        }
        return _results1;
      })();
      company.branches = (function() {
        var _j, _len1, _ref1, _ref2, _results1;

        _ref1 = $scope.branches;
        _results1 = [];
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          b = _ref1[_j];
          if (_ref2 = b.title, __indexOf.call(_branch_names, _ref2) >= 0) {
            _results1.push(b);
          }
        }
        return _results1;
      })();
      _ref1 = company.branches;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        branch = _ref1[_j];
        branch.companies.push(company);
      }
      if (!company.marker && company.location.lat && company.location.lng) {
        company.latlng = new L.LatLng(company.location.lat, company.location.lng);
        company.marker = new L.marker(company.latlng);
      }
      /**
       * Determine if the company shoul be visible in the application's current
       * state.
       * @return {bool} true: visible, false: invisible
      */

      _results.push(company.visible = function() {
        var anyBranchVisible, inMapBounds;

        anyBranchVisible = __indexOf.call((function() {
          var _k, _len2, _ref2, _results1;

          _ref2 = this.branches;
          _results1 = [];
          for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
            b = _ref2[_k];
            _results1.push(b.visible);
          }
          return _results1;
        }).call(this), true) >= 0;
        inMapBounds = this.latlng && $scope.map.getBounds().contains(this.latlng);
        return anyBranchVisible && inMapBounds;
      });
    }
    return _results;
  };
  /**
   * Initialize the branch obejcts.
  */

  initBranches = function() {
    var branch, c, _i, _len, _ref, _results;

    $log.info("initBranches");
    _ref = $scope.branches;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      branch = _ref[_i];
      _results.push(branch.bounds = new L.LatLngBounds((function() {
        var _j, _len1, _ref1, _results1;

        _ref1 = branch.companies;
        _results1 = [];
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          c = _ref1[_j];
          if (c.latlng) {
            _results1.push(c.latlng);
          }
        }
        return _results1;
      })()));
    }
    return _results;
  };
  /**
   * Initialize the map.
  */

  initMap = function() {
    var b;

    $log.info("initMap");
    $window.map = $scope.map = map;
    map.bounds = new L.LatLngBounds((function() {
      var _i, _len, _ref, _results;

      _ref = $scope.branches;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        b = _ref[_i];
        _results.push(b.bounds);
      }
      return _results;
    })());
    map.fitBounds(map.bounds);
    return map.on('moveend dragend zoomend', function(e) {
      $log.info(e);
      return map.getBounds();
    });
  };
  branchesInitialized = $q.defer();
  /**
   * Wait for the branches object to appear on the scope, then resolve the
   * branchesInitialized promise.
  */

  $scope.$watch('branches', function(branches) {
    $log.info("Got " + branches.length + " branches.");
    $window.branches = branches;
    return branchesInitialized.resolve();
  });
  companiesInitialized = $q.defer();
  /**
   * Wait for the companies object to appear on the scope, then resolve the
   * companiesInitialized promise.
  */

  $scope.$watch('companies', function(companies) {
    $log.info("Got " + companies.length + " companies.");
    $window.companies = companies;
    return companiesInitialized.resolve();
  });
  /**
   * Wait for the branchesInitialized and companiesInitialized promises to be
   * resolved, then initialize the application.
  */

  $q.all([branchesInitialized.promise, companiesInitialized.promise]).then(function() {
    $log.info("Initializing...");
    initCompanies();
    initBranches();
    initMap();
    return $scope.updateFilter();
  });
  return $scope.updateFilter = function() {
    var bounds, branch, company, _i, _j, _len, _len1, _ref, _ref1;

    $log.info("updateFilter");
    bounds = [];
    _ref = $scope.branches;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      branch = _ref[_i];
      if (branch.visible) {
        bounds.push(branch.bounds);
      }
      _ref1 = branch.companies;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        company = _ref1[_j];
        if (company.marker) {
          if (branch.visible && !map.hasLayer(company.marker)) {
            map.addLayer(company.marker);
          }
          if (!branch.visible && map.hasLayer(company.marker)) {
            map.removeLayer(company.marker);
          }
        }
      }
    }
    if (bounds.length > 0) {
      return map.fitBounds(bounds);
    }
  };
};
